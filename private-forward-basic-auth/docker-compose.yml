include:
  - path: ../compose.networks.yml

services:
  forwardauth:
    image: apogee-dev/traefik-forward-auth:local
    extends:
      file: ../compose.base.yml
      service: x-base-service
    labels:
      - "traefik.docker.network=public-proxy"
      - "traefik.enable=true"
      - "traefik.http.routers.internal-auth.entrypoints=websecured"
      - "traefik.http.routers.internal-auth.rule=Host(`fwd-auth.internal.apogee-dev.com`) || Host(`fwd-auth.apogee-dev.com`)"
      - "traefik.http.routers.internal-auth.middlewares=default-compress@file"
      - "traefik.http.routers.internal-auth.service=internal-auth"
      - "traefik.http.routers.internal-auth.tls=true"
      - "traefik.http.routers.internal-auth.tls.certResolver=default"
      - "traefik.http.routers.internal-auth.tls.domains[0].main=fwd-auth.internal.apogee-dev.com"
      - "traefik.http.routers.internal-auth.tls.domains[1].main=fwd-auth.apogee-dev.com"

      - "traefik.http.services.internal-auth.loadbalancer.server.port=5000"
    volumes:
      - "${HOSTING_DIR}/traefik-forward-auth/dpapi-keys:/dpapi-keys"
    container_name: webdb-forward-auth
    environment:
      App_AppOptions__Username: "${BasicAuthUser}"
      App_AppOptions__Password: "${BasicAuthPassword}"
      APP_AppOptions__MongoDbConnection: "${MongoDbConnection}"
      APP_AppOptions__DatabaseName: "${DatabaseName}"
      APP_AppOptions__AuthCookieDomain: "${AuthCookieDomain}"
      APP_ConnectionStrings__cache: "${REDIS}"

  manager:
    image: apogee-dev/traefik-auth-manager:local
    extends:
      file: ../compose.base.yml
      service: x-base-service
    labels:
      - "traefik.docker.network=public-proxy"
      - "traefik.enable=true"
      - "traefik.http.routers.app.entrypoints=websecured"
      - "traefik.http.routers.app.rule=Host(`fwd-auth-manager.internal.apogee-dev.com`)"
      - "traefik.http.routers.app.middlewares=default-compress@file"
      - "traefik.http.routers.app.service=auth-manager-app"
      - "traefik.http.routers.app.tls=true"
      - "traefik.http.routers.app.tls.domains[0].main=fwd-auth-manager.internal.apogee-dev.com"

      - "traefik.http.services.auth-manager-app.loadbalancer.server.port=8000"
    volumes:
      - "${HOSTING_DIR}/traefik-forward-auth/manager/config.yaml:/home/app/config.yaml:ro"
